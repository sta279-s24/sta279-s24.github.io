---
title: "Homework 6"
output: 
  rmdformats::robobook:
    css: "homework.css"
    highlight: pygments
link-citations: yes
---

**Due:** Friday, March 22, 2:00pm on Canvas

**Instructions:** 

* Download the [HW 6 template](https://sta279-s24.github.io/homework/hw_6_template.qmd), and open the template (a Quarto document) in RStudio. 
* Put your name in the file header
* Click `Render`
* Type all code and answers in the document (using `###` for section headings and `####` for question headings)
* Render early and often to catch any errors!
* When you are finished, submit the final rendered HTML to Canvas

**Code guidelines:**

* If a question requires code, and code is not provided, you will not receive full credit
* You will be graded on the quality of your code. In addition to being correct, your code should also be easy to read
  * No magic numbers
  * Use descriptive names for your variables
  * Set seeds where needed
  * Comment code
  * If a block of code is being called multiple times, put it in a function
  
**Resources:** In addition to the class notes and activities, I recommend reading the following resources:

* [Chapter 4](https://mdsr-book.github.io/mdsr3e/04-dataI.html) and [Chapter 6](https://mdsr-book.github.io/mdsr3e/06-dataII.html) in *Modern Data Science with R*
* [Chapter 4](https://r4ds.hadley.nz/data-transform) and [Chapter 6](https://r4ds.hadley.nz/data-tidy) in *R for Data Science* (2nd edition)
* [Chapter 15](https://mdsr-book.github.io/mdsr3e/15-sqlI.html) in *Modern Data Science with R*
* [Chapter 22.5](https://r4ds.hadley.nz/databases#sql) in *R for Data Science* (2nd edition)



## Baseball data

The `Teams` data in the `Lahman` package contains information on professional baseball teams since 1871. 

:::{.question}
#### Question 1

Using the `Teams` data, create a plot of the number of home runs scored (`HR`) and allowed (`HRA`) by the Chicago Cubs (`teamID` CHN) in each season. Your plot should look like close to this:

```{r, echo=F, message=F, warning=F}
library(Lahman)
library(tidyverse)

Teams |>
  filter(teamID == "CHN") |>
  select(yearID, HR, HRA) |>
  pivot_longer(-yearID,
               names_to = "team",
               values_to = "runs") |>
  mutate(team = ifelse(team == "HR", "Cubs", "Opponent")) |>
  ggplot(aes(x = yearID, y = runs, color = team)) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Runs", color = "Team") +
  theme_bw()
```

You may use whichever R functions you like to create the plot, but the axes and legend should be labeled as in the plot above.

:::


## Practice pivoting

:::{.question}
#### Question 2

The code below creates a data frame called `df1`:

```{r}
df1 <- data.frame(
  grp = c("A", "A", "B", "B"),
  sex = c("F", "M", "F", "M"),
  meanL = c(0.225, 0.47, 0.325, 0.547),
  sdL = c(0.106, 0.325, 0.106, 0.308),
  meanR = c(0.34, 0.57, 0.4, 0.647),
  sdR = c(0.0849, 0.325, 0.0707, 0.274)
)

df1
```

Using `pivot_longer` and `pivot_wider`, reshape `df1` to produce the following output:

```{r, echo=F}
df1 |>
  pivot_longer(-c(grp, sex),
               names_to = "stat", values_to = "value") |>
  pivot_wider(id_cols = grp,
              names_from = c(sex, stat),
              names_sep = ".",
              values_from = value)
```

Remember that the `?` provides documentation in R. For example, running `?pivot_wider` in the console gives helpful information about the `pivot_wider` function.
:::

## Practice pivoting

The code below creates a data frame called `df2`:

```{r}
df2 <- data.frame(id = rep(c(1, 2, 3), 2),
                  group = rep(c("T", "C"), each=3),
                  vals = c(4, 6, 8, 5, 6, 10))

df2
```

An analyst wants to calculate the pairwise differences between the Treatment (T) and Control (C) values for each individual in this dataset. They use the following code:

```{r}
Treat <- filter(df2, group == "T")
Control <- filter(df2, group == "C")
all <- mutate(Treat, diff = Treat$vals - Control$vals)
all
```


:::{.question}
#### Question 3

Verify that this code works for this example and generates the correct values of -1, 0, and -2. Describe two problems that might arise if the data set is not sorted in a particular order or if one of the observations is missing for one of the subjects.
:::

:::{.question}
#### Question 4

Provide an alternative approach to generate the `diff` variable, using `group_by` and `summarize` to produce the following output:

```{r, echo=F}
df2 |>
  group_by(id) |>
  summarize(diff = vals[group == "T"] - vals[group == "C"])
```

:::

:::{.question}
#### Question 5

Provide an alternative approach to generate the `diff` variable that uses `pivot_wider` and `mutate` to produce the following output:

```{r, echo=F}
df2 |>
  pivot_wider(id_cols = id,
              names_from = group,
              values_from = vals) |>
  mutate(diff = T - C)
```

:::


# Practice with SQL

In the second part of this assignment, you will continue practicing data wrangling with SQL. You will already be familiar with all of the ideas needed to complete these questions, but you might not have seen all of them for SQL. The book chapters listed above will be helpful.

To practice with SQL, we will return to the `airlines` database we used in class.  Connect to the database and send a short query:

```{r, eval=F}
library(tidyverse)
library(mdsr)
library(DBI)

db <- dbConnect_scidb("airlines")

query <- "
  SHOW TABLES;
"
dbGetQuery(db, query)
```

**Important note:** Make sure to always LIMIT the number of rows you return from your queries!


:::{.question}
#### Question 6

Of all the destinations from Chicago Oâ€™Hare (ORD), which were the most common in 2014?

:::

:::{.question}
#### Question 7

Which airport had the highest average arrival delay time in 2014?

:::

:::{.question}
#### Question 8

Re-do Question 7, but this time display the full name of each airport in the output. (Hint: use a JOIN)

:::

:::{.question}
#### Question 9

Find all flights between JFK and SFO in 2014. How many were canceled? What percentage of the these flights were canceled?

:::




